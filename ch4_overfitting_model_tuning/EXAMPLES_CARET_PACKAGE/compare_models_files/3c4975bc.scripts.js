"use strict";angular.module("DataCampApp.filters",[]),angular.module("DataCampApp.services",[]),angular.module("DataCampApp.directives",[]),angular.module("DataCampApp.controllers",[]),angular.module("DataCampApp",["ui.jq","ngRoute","ngSanitize","DataCampApp.rconsole","DataCampApp.codeEditor","DataCampApp.filters","DataCampApp.services","DataCampApp.directives","DataCampApp.controllers"]).config(["$httpProvider",function(a){a.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1,resolve:MainCtrl.resolve}),a.when("/fiddle",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1,resolve:MainCtrl.resolve}),a.when("/fiddle/:id",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1,resolve:MainCtrl.resolve}),a.when("/fiddle/:id/:version",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1,resolve:EmbedCtrl.resolve}),a.when("/embed",{templateUrl:"views/main_embed.html",controller:"EmbedCtrl",reloadOnSearch:!1,resolve:EmbedCtrl.resolve}),a.when("/embed/:id",{templateUrl:"views/main_embed.html",controller:"EmbedCtrl",reloadOnSearch:!1,resolve:EmbedCtrl.resolve}),a.when("/embed/:id/:version",{templateUrl:"views/main_embed.html",controller:"EmbedCtrl",reloadOnSearch:!1,resolve:EmbedCtrl.resolve}),a.when("/preview",{templateUrl:"views/main_preview.html",controller:"PreviewCtrl",reloadOnSearch:!1,resolve:PreviewCtrl.resolve}),a.when("/preview/:id",{templateUrl:"views/main_preview.html",controller:"PreviewCtrl",reloadOnSearch:!1,resolve:PreviewCtrl.resolve}),a.when("/preview/:id/:version",{templateUrl:"views/main_preview.html",controller:"PreviewCtrl",reloadOnSearch:!1,resolve:PreviewCtrl.resolve}),a.when("/query/fiddle",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:MainCtrl.resolve}),a.when("/query/embed/",{templateUrl:"views/main_embed.html",controller:"EmbedCtrl",resolve:EmbedCtrl.resolve}),a.when("/query/preview",{templateUrl:"views/main_preview.html",controller:"PreviewCtrl",resolve:PreviewCtrl.resolve}),a.when("/help",{templateUrl:"views/help.html"}),a.otherwise({redirectTo:"/"})}]).run(["$rootScope","$window","$location",function(a,b,c){var d=function(){var a=c.url();b._gaq.push(["_trackPageview",a])};a.$on("$viewContentLoaded",d),a.googleTrackPage=function(a){b._gaq.push(["_trackPageview",a])}}]);var MainCtrl=function(a,b,c,d,e){a.console={},a.graph={};var f='demo("graphics")';a.hostname=document.location.hostname,angular.isDefined(b.id)?(a.showShareTour=!0,angular.isDefined(b.version)?(a.permalink="?id="+b.id+"&version="+b.version,d.getVersion(b.id,b.version).then(function(b){a.code=b.code})):(a.permalink="?id="+b.id,d.get(b.id).then(function(b){a.code=b.code}))):a.code=f,angular.isDefined(b.code)&&(a.code=decodeURIComponent(b.code)),c(function(){a.console.createSession(1337,!1)},500),a.saveFiddle=function(){var c={};angular.isDefined(b.id)?(c.fiddle_id=b.id,c.version={code:a.code},d.save(b.id,c).then(function(c){a.permalink="?id="+b.id+"&version="+c.data.relative_number,e.path("/fiddle").search({id:b.id,version:c.data.relative_number})})):(c.code=a.code,d.init(c).then(function(b){a.permalink="?id="+b.token,e.path("/fiddle").search({id:b.token})}))},a.runCode=function(){a.console.runCode(a.code),f!==a.code&&angular.isUndefined(a.permalink)&&a.saveFiddle()};var g=!1;a.toggleDisqus=function(){g===!0?($("#disqus").hide(),$("#main-content").removeClass("disqus-shown")):($("#disqus").show(),$("#main-content").addClass("disqus-shown"),loadDisqus(b.id)),g=!g}};MainCtrl.resolve={rconsole:["asyncRconsoleLoader",function(a){return a.asyncLoad()}],codeEditor:["codeEditorService",function(a){return a.asyncLoad()}]},angular.module("DataCampApp.controllers").controller("MainCtrl",["$scope","$routeParams","$timeout","Fiddle","$location",MainCtrl]);var EmbedCtrl=function(a,b,c,d){a.console={},a.graph={};var e=!1;angular.isDefined(b.id)&&(angular.isDefined(b.version)?(a.permalink="?id="+b.id+"&version="+b.version,d.getVersion(b.id,b.version).then(function(b){a.code=b.code})):(a.permalink="?id="+b.id,d.get(b.id).then(function(b){a.code=b.code}))),angular.isDefined(b.code)&&(a.code=decodeURIComponent(b.code)),a.activateConsole=function(){a.console.createSession(1337,!1),e=!0,$(".activate-console").hide(),$("#console").show()},a.edit=function(){angular.isDefined(b.id)?window.open("/#/fiddle"+a.permalink,"_blank"):angular.isDefined(b.code)&&window.open("/#/query/fiddle?code="+encodeURIComponent(a.code),"_blank")},a.runCode=function(){e===!0?a.console.runCode(a.code):a.activateConsole()}};EmbedCtrl.resolve={rconsole:["asyncRconsoleLoader",function(a){return a.asyncLoad()}],codeEditor:["codeEditorService",function(a){return a.asyncLoad()}]},angular.module("DataCampApp.controllers").controller("EmbedCtrl",["$scope","$routeParams","$timeout","Fiddle",EmbedCtrl]);var PreviewCtrl=function(a,b,c){angular.isDefined(b.id)&&(angular.isDefined(b.version)?(a.permalink="?id="+b.id+"&version="+b.version,c.getVersion(b.id,b.version).then(function(b){a.code=b.code})):(a.permalink="?id="+b.id,c.get(b.id).then(function(b){a.code=b.code}))),angular.isDefined(b.code)&&(a.code=decodeURIComponent(b.code)),a.edit=function(){angular.isDefined(b.id)?window.open("/#/fiddle"+a.permalink,"_blank"):angular.isDefined(b.code)&&window.open("/#/query/fiddle?code="+encodeURIComponent(a.code),"_blank")},a.aceLoaded=function(a){a.setReadOnly(!0)},$(".preview").keypress(function(){$("#editButton").toggleClass("blink")})};PreviewCtrl.resolve={codeEditor:["codeEditorService",function(a){return a.asyncLoad()}]},angular.module("DataCampApp.controllers").controller("PreviewCtrl",["$scope","$routeParams","Fiddle",PreviewCtrl]),angular.module("DataCampApp.directives").directive("keybindsEditor",function(){return{restrict:"EA",link:function(a,b){$(b).keydown(function(b){(b.metaKey||b.ctrlKey)&&13===b.keyCode&&(b.preventDefault(),a.runCode()),(b.metaKey||b.ctrlKey)&&b.altKey&&82===b.keyCode&&(b.preventDefault(),b.preventDefault(),a.runCode()),(b.metaKey||b.ctrlKey)&&37===b.keyCode&&(b.preventDefault(),a.prevExercise(),a.$apply()),(b.metaKey||b.ctrlKey)&&39===b.keyCode&&(b.preventDefault(),a.nextExercise(),a.$apply()),(b.metaKey||b.ctrlKey)&&b.altKey&&85===b.keyCode&&(b.preventDefault(),a.exercise.sample_code=angular.copy(a.sample_code),a.$apply())})}}}),angular.module("DataCampApp.codeEditor",[]).factory("codeEditorService",["$rootScope","$q",function(a,b){return{asyncLoad:function(){var c=b.defer();return $script(["//s3.amazonaws.com/assets.datacamp.com/js/ace.js"],"first"),$script.ready("first",function(){$script(["//s3.amazonaws.com/assets.datacamp.com/js/ace-mode-r.min.js","//s3.amazonaws.com/assets.datacamp.com/js/ace-theme_datacamp.min.js","//s3.amazonaws.com/assets.datacamp.com/js/ace-theme_datacamp_light.min.js"],function(){a.$apply(function(){c.resolve()})})}),c.promise}}}]).directive("codeEditor",["$rootScope",function(){return{restrict:"EA",replace:!0,require:"?ngModel",scope:{control:"="},link:function(a,b,c,d){var e,f;e=window.ace.edit(b[0]),e.renderer.setShowGutter(!0),e.setHighlightActiveLine(!1),e.setHighlightGutterLine(!1),e.setShowPrintMargin(!1),e.setFontSize("0.8em"),f=e.getSession(),f.setMode("ace/mode/r"),f.setUseWrapMode(!0),angular.isDefined(d)&&(d.$formatters.push(function(a){if(angular.isUndefined(a)||null===a)return"";if(angular.isObject(a)||angular.isArray(a))throw new Error("ui-ace cannot use an object or an array as a model");return a}),d.$render=function(){f.setValue(d.$viewValue)}),f.on("change",function(){var b=f.getValue();b===a.$eval(c.value)||a.$$phase||angular.isDefined(d)&&d.$setViewValue(b)}),a.$on("resizeEditor",function(){e.renderer.updateFull(!0),e.resize()})}}}]),angular.module("DataCampApp.rconsole",[]).factory("asyncRconsoleLoader",["$rootScope","$q",function(a,b){return{asyncLoad:function(){var c=b.defer();return $script(["https://cdn.socket.io/socket.io-1.1.0.js"],function(){a.$apply(function(){c.resolve()})}),c.promise}}}]).factory("socket",["$rootScope","$q",function(a){var b="http://rconsole.r-fiddle.org:80/",c=io.connect(b,{reconnection:!1}),d=!1;return{on:function(b,d){c.on(b,function(){var b=arguments;a.$apply(function(){d.apply(c,b)})})},emit:function(b,e,f){d===!1&&c.emit(b,e,function(){var b=arguments;a.$apply(function(){f&&f.apply(c,b)})})},lockSocket:function(){d=!0},unlockSocket:function(){d=!1},reset:function(){d=!1,c.removeAllListeners("executed"),c.removeAllListeners("finished")}}}]).directive("rConsole",["socket","$timeout","$sanitize","$rootScope","$compile",function(a,b,c,d){return{restrict:"EA",scope:{control:"="},link:function(e,f){function g(){w.Prompt(!0,function(b){if(null!==b.match(/system(.*?)/))window.open("https://s3.amazonaws.com/assets.datacamp.com/baws.jpg","_blank");else{b=r(b);var c={DC_CODE:b};a.emit("console",c)}g()})}function h(a,b){b?w.Write(a,"jqconsole-error",!1):w.Write(a+"<br />","jqconsole-error",!1)}function i(a){w.Write(a+"<br />","jqconsole-code",!1)}function j(a){w.Write(a,"jqconsole-output",!1)}function k(){h("Looks like the something is wrong with the R session. Please refresh the page to get a new session. Sorry for this inconvenience. If this problem persists, please contact us at info@datacamp.com"),x=!0}function l(){a.emit("keep-alive"),z=b(l,1e4)}function m(){b.cancel(y),b.cancel(z),a.reset()}function n(){a.on("finished",function(){A=!1,a.unlockSocket(),b.cancel(y),e.$parent.disableButtons=!1,x&&(i("Connection succeeded!"),x=!1),B===!0&&(B=!1,e.console.createSession(u,v))}),a.on("executed",function(a){e.$parent.disableButtons=!1,o(angular.fromJson(a))})}function o(a){angular.forEach(a,function(a,c){b(function(){q(a)},100*(c+1))})}function p(a){return a.replace(/\</g,"&lt;").replace(/\>/g,"&gt;")}function q(b){var c=b.payload;switch(b.type){case"code":i("> "+p(c));break;case"output":null!==c&&""!==c&&"NULL"!==c&&j(p(c));break;case"iframe":var f="data:text/html;charset=utf-8,"+escape(c);d.$broadcast("showViewer",f);break;case"graph":var g="data:image/png;base64,"+s(c);d.$broadcast("showGraph",g);break;case"help":var k=window.open("http://www.rdocumentation.org/goto/"+c,"_blank");angular.isUndefined(k)&&i("Make sure to enable pop-ups. The help file didn't open automatically because your browser doesn't allow pop-ups. <a href =\"http://www.rdocumentation.org/goto/"+c+'" target="_blank">Go to the help page manually</a>');break;case"r-error":case"r-message":case"r-warning":""!==c&&h(p(c));break;case"error":A=!1,a.unlockSocket(),e.$parent.disableButtons=!1,""!==c&&h(p(c.message))}}function r(a){return a.replace(/"/g,"'")}function s(a){return btoa(String.fromCharCode.apply(null,a.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")))}function t(a){b(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])},0)}var u,v,w=f.jqconsole("","> "),x=!1,y=null,z=null,A=!1,B=!1,C=null;e.console=e.control||{},e.console.createAnonSession=function(){a.emit("anon_session"),e.$parent.disableButtons=!0,y=b(k,7e3),z=b(l,1e4)},e.console.createSession=function(c,d){u=c,v=d,A!==!0?(A=!0,a.emit("session",{revo:d}),a.lockSocket(),e.$parent.disableButtons=!0,y&&b.cancel(y),y=b(k,8e3),z&&b.cancel(z),z=b(l,1e4)):B=!0},e.console.runConsole=function(b){i("> "+b),b=r(b);var c={DC_CODE:b};a.emit("console",c)},e.console.runCode=function(b){C=b,b=r(b);var c={DC_CODE:b};a.emit("console",c),e.$parent.disableButtons=!0},e.console.runCodeHidden=function(b){C=b,b=r(b);var c={DC_CODE:b,DC_ECHO:!1};a.emit("submit",c),e.$parent.disableButtons=!0},e.console.showHint=function(a){var b=document.createElement("span");b.className+="jqconsole_feedback feedback_hint";var d=document.createElement("i");d.className+="fa fa-lightbulb-o",b.appendChild(d);var e=document.createElement("div");e.className="text-v-middle";var f=document.createElement("div");f.className="text-v-middle-cell",$(f).append(c(a)),$(e).append(f),$(b).append(e),w.Append(b),t(b)},e.$on("newExercise",function(){w.Reset(),g()}),e.$parent.$on("$routeChangeStart",m),e.$on("$destroy",m),n(),g()}}}]),angular.module("DataCampApp.directives").directive("resizableConsole",["$rootScope",function(a){return{restrict:"EA",link:function(b,c){var d,e,f=null;c.find(".resize-handle").mousedown(function(a){a.stopPropagation(),a.preventDefault(),e=a.pageY,d=c.height(),f=!0}),c.find(".resize-handle").mouseup(function(){a.$broadcast("resizeEditor",null)}),$(document.body).mouseup(function(){f=!1}),$("#middle, .console-wrapper").mousemove(function(a){if(f){a.stopPropagation(),a.preventDefault();var b=d+e-a.pageY;b>50&&a.pageY>120&&(c.height(b),$("#middle").css("bottom",b))}})}}}]),angular.module("DataCampApp.directives").directive("social",function(){return{restrict:"EA",link:function(){"undefined"!=typeof FB&&null!=FB&&FB.XFBML.parse(),angular.isDefined(twttr)&&twttr.widgets.load()}}}),angular.module("DataCampApp.directives").directive("isSpinning",function(){return{restrict:"EA",link:function(a,b,c){var d=b.text();a.$watch(c.isSpinning,function(a){a===!0?b.html('<i class="fa fa-spinner fa-spin icon-large"></i>').attr("disabled","disabled"):b.text(d).removeAttr("disabled")})}}}),angular.module("DataCampApp.directives").directive("graphs",function(){return{restrict:"EA",scope:{shown:"=",control:"=",resizable:"="},link:function(a,b){var c=0,d=[],e=b.find(".graph");if(a.graph=a.control||{},a.graph.previous=function(){c=-1===--c?d.length-1:c,e.attr("src",d[c])},a.graph.next=function(){c=++c%d.length,e.attr("src",d[c])},a.$watch("shown",function(){angular.isDefined(a.shown)&&(a.shown===!0?b.show():b.hide())}),a.$on("showGraph",function(b,f){d.push(f),e.attr("src",d[d.length-1]),c=d.length-1,angular.isDefined(a.shown)&&(a.shown=!0)}),a.$on("newExercise",function(){c=0,d.length=0,e.attr("src",""),angular.isDefined(a.shown)&&(a.shown=!1)}),a.resizable===!0){var f,g,h,i,j,k,l,m=!1;f=$("<div>"),f.css({position:"absolute",width:"10px",height:"100%",top:0,cursor:"w-resize","z-index":"2"}),f.mousedown(function(a){a.stopPropagation(),a.preventDefault(),i=b.width(),k=a.pageX,m=!0}),g=$("<div>"),g.css({position:"absolute",height:"10px",width:"100%",bottom:0,cursor:"s-resize","z-index":"1"});var n=function(a){a.stopPropagation(),a.preventDefault(),j=b.height(),l=a.pageY,m=!0};g.mousedown(n),h=$("<div>"),h.css({position:"absolute",height:"10px",width:"10px",bottom:0,left:"0",cursor:"sw-resize","z-index":"3"}),h.mousedown(n),b.append(f),b.append(g),b.append(h),$(document.body).mouseup(function(){m=!1,i=null,j=null,k=null,l=null}),$(document.body).mousemove(function(a){var c;m&&null!==i?c=i+k-a.pageX:m&&null!==j&&(c=j-l+a.pageY),c>200&&500>c&&(b.width(c),b.height(c))})}}}}),angular.module("DataCampApp.directives").directive("welcomeTour",function(){return function(a){var b=new Tour({backdrop:!1,useLocalStorage:!0,name:"welcomeTour"});a.$on("$routeChangeStart",function(){b.end()}),a.restartTour=function(){b.restart()},b.addSteps([{element:"#tour_1",title:"STEP 1: Welcome to R-Fiddle!",content:"The page exists out of two sections: the editor and the console.<br><br><b>They work just like the standard editor and console you are familiar with for your IDE.</b> It even colour-codes the syntax.",placement:"top"},{element:"#savebtn",title:"STEP 2: R-Fiddle Controls",content:"By clicking save your fiddle get's saved on our servers and you can share it with others, <b>or even embed it in your own blog.</b>",placement:"bottom"},{element:"#runButton",title:"STEP 3: Run your code",content:"Executes the code entered in the editor, and displays the results in the console area.",placement:"top"},{element:"#tour_4",title:"STEP 4: Comments?",content:"Every fiddle gets its own comment section. <br><br> You can use this for asking help understanding some of the code.",placement:"left"}]),b.start()}}).directive("shareTour",["$rootScope",function(){return function(a){var b=new Tour({backdrop:!1,useLocalStorage:!0,name:"hsdfjdslkfjsdlkfjklmjfklmqdfjldksqfj"});a.$watch("showShareTour",function(a){var c=a||null;c&&b.start()}),b.addSteps([{element:"#embedbtn",title:"Embed your fiddle",content:"This allows you to embed your code on your website or blog. R-fiddle offers two ways to embed your code: with or without the console.",placement:"bottom"},{element:"#embedbtn",title:"Embed your fiddle",content:"If you embed it with the console, your visitors can edit and run your code within the environment your own site. Embedding it without the console, allows them to only edit and run it on a separate page provided by R-fiddle",placement:"bottom"},{element:"#sharebtn",title:"Share your fiddle!",content:"This allows you to share code from the R-fiddle page with other users. The options include Facebook, Twitter and a link.",placement:"bottom"}])}}]),angular.module("DataCampApp.services").factory("Fiddle",["$http",function(a){var b="http://api.r-fiddle.org:80/",c={init:function(c){var d=a({method:"POST",url:b+"fiddles",data:c,headers:{"Content-Type":"application/json"},withCredentials:!0}).then(function(a){return a.data});return d},save:function(c,d){var e=a({method:"POST",url:b+"fiddles/"+c+"/versions",data:d,headers:{"Content-Type":"application/json"},withCredentials:!0});return e},get:function(c){var d=a.get(b+"fiddles/"+c+".json",{withCredentials:!0}).then(function(a){return a.data});return d},getVersion:function(c,d){var e=a.get(b+"fiddles/"+c+"/versions/"+d+".json",{withCredentials:!0}).then(function(a){return a.data});return e},remove:function(c){var d=a({method:"DELETE",url:b+"fiddles/"+c,withCredentials:!0}).then(function(a){return a.data});return d}};return c}]);